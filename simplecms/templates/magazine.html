{% extends "layout.html" %}

{% block title %}
<title>{{ magazine.title }}</title>
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{url_for('static', filename='css/magazine.css')}}"/>
{% endblock %}

{% block main %}
<div class="posts">
  {% for post in magazine.posts %}
  {% set origin_url = '/posts/' + (post.post_id|string) %}
  {% set url = post.post_content if post.post_category in ('recipe', 'recipe_list') else origin_url %}
  <div class="post">
    <div class="category">
      <img src="{{ post.category_icon }}" class="category-icon">
      <div class="category-name">{{ post.category }}</div>
    </div>

    <a class="cover"
      href="{{ url }}"
      data-origin-url="{{ origin_url }}"
    >
      <div class="cover-filter"></div>
      <img src="{{ post.cover }}" />
    </a>

    <h2 class="title">
      <a
        href="{{ url }}"
        data-origin-url="{{ origin_url }}"
      >
        {{ post.title }}
      </a>
    </h2>

    <div class="desc">{{ post.desc }}</div>

    <div class="visits">阅读 {{ post.post_visits or 0 }}</div>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block js %}
<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script>
$(document)
  .on('load', '.cover > img', function(){
    $(this).addClass('loaded');
  })
  .on('click', 'a', function(event){
    var $this = $(this);
    var url = $this.attr('href');
    var origin_url = $this.data('origin-url');

    if (origin_url !== url) {
      event.preventDefault();

      $.ajax({
        type: 'head',
        url: origin_url,
        timeout: 500
      })
        .always(function() {
          location.href= url
        });
    }
  })
</script>
{% endblock %}
